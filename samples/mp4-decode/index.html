<!doctype html>
<!DOCTYPE html>
<html>
<head>
  <title>WebCodec MP4 frame extration demo</title>
  <meta http-equiv="origin-trial" content="AlfvFCF6XVoauEvWVCLsov9cuGlQbz6aTIO6ZdLWHG5YmZpdqON+7lXo7ZUHK+IkkdkJji+7Fxnr/yTu7Iu5Og0AAABjeyJvcmlnaW4iOiJodHRwczovL3czYy5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IldlYkNvZGVjcyIsImV4cGlyeSI6MTYyNjIyMDc5OSwiaXNTdWJkb21haW4iOnRydWV9" />
</head>
<body>
  <p>
    This demo extracts all frames from an MP4 file and renders them to a canvas as fast as possible. It uses <a href="https://github.com/gpac/mp4box.js/">mp4box.js</a> to parse and demux the file.
  </p>
  <p>
    Frames extracted: <span id="frameStats"></span>
  </p>
  <canvas></canvas>
</body>
<script>
  var testTargetFrame = null;
  var flattenFrameBuf, flattenFrameBufManel;

  function flattenVideoFrame(frame) {
    const buf1 = new Uint8Array(frame.planes[0].length);
    const buf2 = new Uint8Array(frame.planes[1].length);
    const buf3 = new Uint8Array(frame.planes[2].length);

    frame.planes[0].readInto(buf1);
    frame.planes[1].readInto(buf2);
    frame.planes[2].readInto(buf3);

    return new Uint8Array([...buf1, ...buf2, ...buf3]);
  }



  // function flattenVideoFrame(frame) {
  //   const totalLenght = frame.planes.map(plane => plane.length).reduce((x, y) => x + y, 0);
  //   const buf = new Uint8Array(totalLenght);

  //   for (let i = 0; i < frame.planes.length; i++) {
  //     const startIndex = i >= 1 ? frame.planes[i - 1].length : 0;
  //     const endIndex = startIndex + frame.planes[i].length;
  //     console.log('startIndex: ', startIndex);
  //     const subBuf = buf.subarray(startIndex, endIndex);
  //     frame.planes[i].readInto(subBuf);
  //   }

  //   return buf;
  // }

  // function flattenVideoFrameManel(frame) {
  //   const totalLenght = frame.planes.map(plane => plane.length).reduce((x, y) => x + y, 0);
  //   const imageBuffer = new Uint8Array(totalLenght);
  //   let buffer = null;
  //   for (let i = 0, j = 0; i < frame.planes.length; j += buffer[i].length, i++) {
  //       buffer  = new Uint8Array(frame.planes[i].length);
  //       frame.planes[i].readInto(buffer);
  //       imageBuffer.set(buffer, j);
  //   }
  //   console.log('manel!');
  //   return imageBuffer;
  // }

  function processVideoFrame(frame_) {
    const frame = frame_.clone();
    flattenFrameBuf = flattenVideoFrame(frame);

    const file = new Blob([flattenFrameBuf], {type: 'application/octet-stream'});

    const a = document.createElement("a");
    a.href = URL.createObjectURL(file);
    a.download = name;
    a.click();

    testTargetFrame = frame;
    console.log('there....')
    // frame.close();
  }
</script>
<script src="mp4box.all.min.js"></script>

<script type="module">
  import {MP4Demuxer} from "./mp4_demuxer.js";
  let demuxer = new MP4Demuxer("/webcodecs/samples/media/bbb.mp4");

  var canvas = document.querySelector("canvas");
  var ctx = canvas.getContext('2d');
  document.body.appendChild(canvas);

  var frameCount = 0;
  var startTime;

  async function onFrame(frame) {
    let now = performance.now();

    // console.log('frameCount: ' + frameCount);
    if (frameCount === 30) {
      console.log('here....');
      processVideoFrame(frame);
    }

    ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
    frame.close();

    let fps = "";
    if(frameCount++) {
      let elapsed = now - startTime;
      fps = " (" + (1000.0*frameCount/(elapsed)).toFixed(0) + " fps)"
    } else {
      // This is the first frame.
      startTime = now;
    }

    document.getElementById("frameStats").innerText = frameCount + fps;
  }

  let decoder = new VideoDecoder({
    output: onFrame,
    error: e => console.error(e),
  });

  demuxer.getConfig().then((config) => {
    config.codedWidth = 640;
    config.codedHeight = 360;
    canvas.height = config.codedHeight;
    canvas.width = config.codedWidth;

    decoder.configure(config);
    demuxer.start((chunk) => {
      decoder.decode(chunk);
    })
  });

  window.decoder = decoder;
</script>

</html>

